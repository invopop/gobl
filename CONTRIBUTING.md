# Contributing to GOBL

<img src="https://github.com/invopop/gobl/blob/main/gobl_logo_black_rgb.svg?raw=true" width="181" height="219" alt="GOBL Logo">

Go Business Language. Core library, schemas, and CLI.

Released under the Apache 2.0 [LICENSE](https://github.com/invopop/gobl/blob/main/LICENSE), Copyright 2021-2025 [Invopop S.L.](https://invopop.com).

## Language

The preferred language for contributions is English (American).

## Prerequisites

- **Go 1.24+**
- **[golangci-lint](https://golangci-lint.run/)** for linting and formatting
- **[Mage](https://magefile.org/)** as the build/task runner (`go install github.com/magefile/mage@latest`)
- Key dependencies: [invopop/validation](https://github.com/invopop/validation), [invopop/jsonschema](https://github.com/invopop/jsonschema)

## Design Principles

- **Minimum complexity for legal correctness** across jurisdictions — each regime or addon should implement only what the law requires.
- **Simple > Complex > Complicated.** Readability counts.
- **Validation is non-negotiable.** The system owns the math; rounding, totals, and tax calculations must be deterministic and correct.
- **JSON-native, not XML.** GOBL is designed around JSON from the ground up. XML conversion is handled by companion projects.
- **Fight entropy.** Leave the codebase better than you found it. Follow the DRY principle.

## Architecture

### Registration

Regimes and addons self-register via `init()` functions:

- **Regimes** call `tax.RegisterRegimeDef(New())` in their `init()` — see [`regimes/dk/dk.go`](regimes/dk/dk.go) for an example.
- **Addons** call `tax.RegisterAddonDef(newAddon())` in their `init()`.
- Aggregation is via blank imports in [`regimes/regimes.go`](regimes/regimes.go) and [`addons/addons.go`](addons/addons.go).

### Normalizer / Validator Dispatch

Both regimes and addons use a `switch obj := doc.(type)` pattern to dispatch normalization and validation to the appropriate handler based on the document type. See the `Normalize` and `Validate` functions in [`regimes/dk/dk.go`](regimes/dk/dk.go) for an example.

### Scenarios

Scenarios auto-inject notes, codes, or extensions based on document state (e.g., tax tags, document type). They are defined per-regime or per-addon in `scenarios.go`.

### Extension Keys

Extension keys follow the naming convention `<country>-<platform>-description` (e.g., `es-tbai-product`). They are defined as `cbc.Key` constants.

### JSON Schema

Types can customize their JSON Schema output:

- `JSONSchema() *jsonschema.Schema` — full override of the generated schema.
- `JSONSchemaExtend(s *jsonschema.Schema)` — augment the auto-generated schema (e.g., add enum values).

## Key Directories

The GOBL repository is organized into key directories, each serving a distinct role:

- **addons**: Optional modules that extend GOBL to support additional document formats, country-specific requirements, or custom validation rules.
- **bill**: Core billing logic, including structures and validation for invoices, deliveries, orders, and payments.
- **c14n** (Canonicalization): Ensures consistent JSON formatting for digital signatures and verification.
- **cal**: Utilities for date, time, and calendar calculations.
- **catalogues**: Standardized lists and code sets (e.g., country codes, tax categories) used throughout GOBL and its extensions.
- **cbc** (Common Basic Components): Shared building blocks such as keys, codes, and reusable definitions.
- **cmd**: Command-line tools for interacting with and processing GOBL documents.
- **currency**: Currency code definitions, exchange rate handling, and monetary value utilities.
- **data**: Autogenerated resources, including embedded files and static data required by GOBL.
- **dsig**: Digital signature support for signing and verifying GOBL documents.
- **examples**: Sample documents and usage examples for testing and reference.
- **head**: Envelope metadata and header structures used in GOBL document packaging.
- **i18n** (Internationalization): Multilingual support for text and labels across GOBL.
- **internal**: Private utilities and helpers not intended for public use.
- **l10n** (Localization): Country and region-specific definitions, including localization data.
- **note**: Structures for notes, comments, or messages within GOBL documents.
- **num**: Numeric types and precise arithmetic for financial calculations.
- **org**: Data structures for organizations, parties, and related business entities.
- **pay**: Payment methods, terms, and processing logic.
- **pkg**: Shared utility packages used across multiple parts of the codebase.
- **regimes** (Tax Regimes): Country-specific tax rules, rates, and validation logic.
- **schema**: JSON schema generation and validation logic.
- **tax**: Core tax structures and logic, used in documents and by regimes or addons.
- **uuid**: Utilities for generating and handling UUIDs.
- **wasm**: WebAssembly integration for running GOBL in browser environments.

Each directory is designed to encapsulate a specific aspect of GOBL, making it easier to locate, understand, and contribute to the relevant parts of the project.

## Development

GOBL uses [Mage](https://magefile.org/) as its build/task runner. Run `mage -l` to see all available targets.

Common commands:

```bash
mage generate   # Regenerate JSON schemas, definitions, and Go code
mage lint       # Run golangci-lint
mage fix        # Run golangci-lint with auto-fix
mage test       # Run all tests
mage testrace   # Run all tests with the race detector
mage build      # Build the CLI binary
mage install    # Install the CLI binary
mage check      # Full pipeline: lint + generate + test + verify no uncommitted changes
```

To test a single regime or addon:

```bash
go test ./regimes/<cc>/...
go test ./addons/<cc>/<format>/...
```

### Linting and formatting

[golangci-lint](https://golangci-lint.run/) is used to check the code for errors and style issues. The configuration is in the [`.golangci.yaml`](.golangci.yaml) file.

Note: we considered incorporating golangci-lint as a tool directly in the `go.mod`, but due the large amount of dependencies, decided not to do so.

### VS Code setup

[Official docs](https://golangci-lint.run/welcome/integrations/#visual-studio-code)

Add this to your `settings.json` file:

```json
"go.lintTool": "golangci-lint",
"go.lintFlags": [
  "--path-mode=abs",
  "--fast-only"
],
"go.formatTool": "custom",
"go.alternateTools": {
  "customFormatter": "golangci-lint"
},
"go.formatFlags": [
  "fmt",
  "--stdin"
]
```

## Where to Make Changes

GOBL is structured in multiple layers, and choosing the right place for your contribution is important. Consider these four main layers:

1. **GOBL Core**: The foundational packages (e.g., `bill`, `cbc`, `tax`, etc.). Changes here are reviewed carefully, as they affect the entire ecosystem and must align with best practices.
2. **Tax Regimes**: Subdirectories within the `regimes` package, each implementing country-specific tax rules, rates, and validation logic. See the following sections for details on adding regimes.
3. **Addons**: Extensions that handle specialized formats or unique normalization/validation rules. Addons may define extension codes to support reliable conversion of GOBL documents.
4. **External Applications**: Business logic that doesn't fit within GOBL itself, typically because it involves relationships between documents or relies on persistent storage.

If you're unsure where your change belongs, feel free to open an issue or discussion for guidance.

## Adding a new regime

Start by researching the country's tax and invoicing regulations. Prefer official governmental sources and collect the
URLs as you go (you'll need them later).

Create a new directory under `regimes/` named with the 2-letter country code. The best way to learn how a regime is
structured is to read an existing one. Use a recent and/or similar regime (e.g. [`regimes/dk/`](regimes/dk/)) to build upon.

A minimal regime needs four files:

- `<cc>.go`: declares the regime and defines its metadata.
- `tax_categories.go`: declares tax categories with rates and, optionally, historical values.
- `tax_identity.go`: implements tax ID normalization, validation, classification, etc.
- `invoices.go`: implements invoice-level validation (e.g. supplier must have a tax ID).

Depending on the requirements you may also need:

- `scenarios.go`: most regimes only need the shared baseline scenarios (`bill.InvoiceScenarios()`). Add a country-specific file when the regime requires its own mappings.
- `corrections.go`: only needed when the country's regulation explicitly constrains which correction types are valid. Omitting the `Corrections` field entirely means any correction type is accepted.
- `identities.go`: for non-tax identifiers that can appear on invoices as alternatives to the tax ID.

After you've implemented the regime:

- Include test files for any regime-specific logic. Purely declarative files don't need any: they are covered by GOBL core tests.
- Add a blank import in [`regimes/regimes.go`](regimes/regimes.go) to register the new regime.
- Add at least one GOBL example document in `examples/<cc>/` and run `go test --update ./...` to regenerate the output files.
- Run `mage check` to lint, regenerate schemas, run tests, and verify a clean git state.

## Adding a new addon

Addons extend GOBL with format-specific or platform-specific normalization, validation, and scenarios.

- Create a new directory under `addons/<cc>/<format>/` (e.g., `addons/es/tbai/`).
- Implement a `newAddon()` function that returns a `*tax.AddonDef`, following the same patterns as regimes (normalizer, validator, scenarios, extension keys).
- Self-register via `init()` with `tax.RegisterAddonDef(newAddon())`.
- Add a blank import in [`addons/addons.go`](addons/addons.go) to ensure the addon is loaded.
- Include tests for all normalization and validation logic.
